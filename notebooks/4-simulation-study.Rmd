---
title: "R Notebook"
output: html_notebook
---

```{r}
library(gmm)
library(matrixStats)
```

# Simulation study -- non-parametric 

```{r}
nonpar_df <- readRDS(file = "../data/df-sim-nonpar.rds")
nonpar_df$y <- as.factor(nonpar_df$y)
nonpar_df$x1 <- as.factor(nonpar_df$x1)
nonpar_df$x2 <- as.factor(nonpar_df$x2)
## eta <- 1 +  1(df$y == 2)
set.seed(123)
flag <- rbinom(n = NROW(nonpar_df), size = 1, prob = nonpar_df$probs_mar) 
nonpar_df$d <- flag
head(nonpar_df)
prop.table(table(nonpar_df$y))
prop.table(table(nonpar_df$y[nonpar_df$d==1]))
```

### Calibration

```{r}
Xs <- totals <- xtabs(~ x1 + x2, data = nonpar_df)
y_des <- svydesign(ids =~ 1, data = subset(nonpar_df, d == 1))
y_des_cal <- calibrate(y_des, formula = list(~ x1 + x2), population = list(Xs))
prop.table(svytable(~y, y_des))
prop.table(svytable(~y, y_des_cal))
prop.table(table(nonpar_df$y))
```


# Simulation study -- cbop

### Chang-Kott / Kott-Chang model

```{r}
cbop_sim <- readRDS(file = "../data/df-sim-cbop.rds")

sim_res <- list()
sim_phi <- list()
sim_naive <- list()

for (i in 1:500) {
  set.seed(i)
  flag <- rbinom(n = NROW(cbop_sim), size = 1, prob = cbop_sim$probs_nmar_13) 
  cbop_sim$d <- flag
  totals <- colSums(model.matrix(~ zawod1, data = cbop_sim))

  Y <- model.matrix(~ y-1, data = subset(cbop_sim, d==1))
  X <- model.matrix(~ y, data = subset(cbop_sim, d==1))
  Z <- model.matrix(~ zawod1, data = subset(cbop_sim, d==1))
  phi <- rep(0, ncol(X))
  d <- rep(nrow(cbop_sim)/nrow(X), nrow(Z))

  res <- nmar_chang_kott(Y=Y, X = X, Z=Z, d = d, totals = totals, control = list(eps=0.00001, maxiter = 2000))
  sim_res[[i]] <- res$y_hat
  sim_phi[[i]] <- res$phi
  sim_naive[[i]] <- prop.table(table(cbop_sim$y[cbop_sim$d==1]))
}
 
nmar_bias <- colMeans(do.call('rbind', sim_res)) - prop.table(table(cbop_sim$y))
naive_bias <- colMeans(do.call('rbind', sim_naive)) - prop.table(table(cbop_sim$y))
nmar_phi <- t(do.call('cbind',sim_phi))
boxplot(nmar_phi)

nmar_vars <- colVars(do.call('rbind', sim_res))
naive_vars <- colVars(do.call('rbind', sim_naive))

nmar_mse <- nmar_bias^2 + nmar_vars
naive_mse <- naive_bias^2 + naive_vars

sqrt(nmar_mse)
sqrt(naive_mse)
sqrt(nmar_vars)
res$y_se

nmar_bias
naive_bias

boxplot(cbind(do.call('rbind', sim_res), do.call('rbind', sim_naive)))

```

```{r}
Xs <- xtabs(~ zawod1, data = cbop_sim)
y_des <- svydesign(ids =~ 1, data = subset(cbop_sim, d == 1))
y_des_cal <- calibrate(y_des, formula = list(~  zawod1), population = list(Xs))
prop.table(svytable(~y, y_des)) - prop.table(table(cbop_sim$y))
prop.table(svytable(~y, y_des_cal)) - prop.table(table(cbop_sim$y))
```
